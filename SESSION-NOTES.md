# FortiGate 60F CMMC Setup - Session Notes

## Session Overview
**Date:** November 2025
**Duration:** Extended configuration session
**Status:** Configuration complete, ready for physical deployment
**Next Session:** VPN configuration with Azure AD SAML after internet connectivity established

---

## What We Accomplished

### 1. Initial Setup & Planning
- **Goal:** Configure FortiGate 60F with FIPS-CC mode and CMMC Level 2 compliance
- **Starting point:** Factory fresh FortiGate 60F, firmware 7.2.6
- **Target:** CMMC Level 2 compliant firewall replacing existing SonicWall

### 2. Firmware Upgrade
- **From:** FortiOS 7.2.6 build1575
- **To:** FortiOS 7.4.9 build2829 (GA.M)
- **Reason:** CMMC mode availability (initially thought to be in 7.4.x, but discovered it doesn't exist as single toggle)
- **Method:** Manual download from support.fortinet.com, uploaded via GUI

### 3. FIPS-CC Mode Enablement
- **Enabled:** FIPS-CC mode for FIPS 140-2 validated cryptography
- **Impact:**
  - Configuration was reset (as expected)
  - Security Level changed to "High"
  - Cannot be disabled without factory reset
  - Admin password was reset during enablement (15+ char requirement)
- **Important:** This is IRREVERSIBLE - once enabled, only factory reset can disable it

### 4. Network Configuration

**WAN Interface:**
- **Production:** wan1.847 (VLAN sub-interface)
  - VLAN ID: 847
  - IP: 204.186.251.250/30
  - Gateway: 204.186.251.249
  - Status: Down (no cable connected yet)
- **Note:** Initially used wan1 with DHCP for testing, caused subnet conflict with CORP VLAN, resolved by configuring production VLAN 847

**Internal VLANs (on "internal" hardware switch):**
- All configured as sub-interfaces of "internal" switch
- Physical ports internal1-5 are members of this switch
- UniFi switch will connect to any internal port (trunk with VLANs 3,4,5,6)

**VLAN Details:**
- internal.3 (IoT Guest): 172.16.3.1/24, DHCP 100-200
- internal.4 (CORP-LAN): 172.16.4.1/24, DHCP 100-200
- internal.5 (Studio-LAN): 172.16.5.1/24, DHCP 100-200
- internal.6 (Guest Network): 172.16.6.1/24, DHCP 100-200
**Note:** Interface names are `internal.X` (not `internal1.X` as originally documented)

**Management:**
- Originally configured on DMZ port (192.168.99.1/24) for initial access
- Moved to CORP-LAN (internal1.4: 172.16.4.1) for production
- DHCP removed from DMZ port
- DMZ now available for actual DMZ use

### 5. DHCP Configuration
- DHCP servers configured for all VLANs
- DNS servers: 1.1.1.1 (primary), 8.8.8.8 (secondary)
- Lease time: 86400 seconds (24 hours)
- IP ranges: x.x.x.100-200 for all VLANs
- Gateway: First IP in each subnet (x.x.x.1)

### 6. Firewall Policies
**Default FIPS-CC Policies (1-6):**
- Auto-generated by FIPS-CC mode
- Block bogon traffic (Class-E, Local-Link, non-global IPv6)
- Do not modify or delete

**User-Created Policies:**
- Policy 11: Management (dmz) → Internet
- Policy 12: Studio (internal1.5) → Internet
- Policy 13: IoT (internal1.3) → Internet
- Policy 14: Guest (internal1.6) → Internet
- Policy 15: CORP (internal1.4) → Internet

**All policies:**
- Destination: wan1.847 (production WAN)
- NAT: Enabled
- Logging: All traffic logged (CMMC requirement)
- Status: Enabled
- No inter-VLAN communication permitted (isolation)

### 7. CMMC Level 2 Security Settings

**Applied Settings:**
- Admin timeout: 15 minutes
- Console timeout: 300 seconds (5 minutes)
- Account lockout: 3 failed attempts
- Lockout duration: 300 seconds
- HTTPS redirect: Enabled
- Telnet: Disabled
- SSH v1: Disabled
- Pre-login banner: Enabled
- Post-login banner: Enabled
- CLI audit log: Enabled
- SSL connection logging: Enabled
- TLS minimum version: TLS 1.2
- Multi-factor authentication: Optional (will be enforced via Azure AD)

**Password Policy:**
- Status: Enabled
- Minimum length: 15 characters
- Lowercase required: 1
- Uppercase required: 1
- Numbers required: 1
- Special characters required: 1
- Password expiry: 90 days
- Password reuse: Disabled

**Note:** SSH cipher configuration commands were not available in this version/FIPS mode - likely auto-restricted by FIPS-CC mode.

---

## Key Decisions Made

### 1. CMMC Mode vs Manual Configuration
**Decision:** Manual CMMC Level 2 configuration
**Reason:** "cmmc-mode" command doesn't exist in FortiOS 7.4.9
**Reality:** CMMC compliance is achieved through individual security settings, not a single mode toggle
**Result:** Manually configured all CMMC Level 2 requirements

### 2. FIPS-CC Mode
**Decision:** Enable FIPS-CC mode
**Reason:**
- Provides FIPS 140-2 validated cryptography (CMMC requirement)
- Automatically enforces strong crypto settings
- Meets NIST 800-171 requirement 3.13.11
**Trade-off:** Irreversible without factory reset, but acceptable for production

### 3. Firmware Version
**Decision:** Upgrade to FortiOS 7.4.9
**Reason:**
- More stable than 7.2.6
- Better security features
- Initially thought required for CMMC mode (turned out not needed, but still beneficial)
**Method:** Direct upgrade from 7.2.6 to 7.4.9 (no intermediate version required)

### 4. Management Network
**Decision:** Management on CORP-LAN (internal1.4), not DMZ
**Reason:**
- Better security (management not on DMZ)
- Aligns with CMMC best practices
- DMZ port freed for actual DMZ use
- No port conflicts with SSL VPN

### 5. Authentication Strategy
**Decision:** Azure AD SAML SSO (not RADIUS)
**Reason:**
- Simpler (no additional servers)
- Cloud-first architecture
- Native MFA support
- Better user experience (SSO)
- No on-prem infrastructure required
- CMMC compliant
**Implementation:** Deferred until after internet connectivity

### 6. VPN Configuration
**Decision:** Configure SSL VPN after internet is working, not before
**Reason:**
- Cannot test VPN without internet
- Cannot configure SAML without Azure AD access
- Logical incremental approach
- Reduces complexity during initial deployment
**Use Case:** Full tunnel VPN for staff internet-only access while traveling (no internal network access)

### 7. Interface Naming
**Decision:** Keep "interface1.6" typo initially, later corrected to "internal1.6"
**Issue:** Had to delete firewall policy first before deleting interface
**Resolution:** Successfully recreated with correct name

### 8. WAN Configuration During Testing
**Decision:** Use wan1 DHCP for initial testing, configure wan1.847 before deployment
**Issue:** Created subnet conflict with CORP-LAN (both 172.16.4.0/24)
**Resolution:** Disconnected test network, configured production VLAN 847, no more conflict

---

## Issues Encountered & Solutions

### 1. CMMC Mode Command Not Found
**Issue:** `set cmmc-mode enable` returned "command parse error"
**Root Cause:** CMMC mode doesn't exist as a single toggle in FortiOS
**Solution:** Manually configured all CMMC Level 2 security requirements
**Lesson:** CMMC compliance is configuration-based, not mode-based

### 2. Subnet Overlap During Testing
**Issue:** wan1 (DHCP) and internal1.4 both on 172.16.4.0/24
**Impact:** Could not enable internal1.4 interface
**Solution:**
  - Disconnected test network
  - Configured production wan1.847 (different subnet)
  - Enabled internal1.4 successfully
**Prevention:** Plan IP addressing before configuration

### 3. Interface Naming Typo
**Issue:** Created "interface1.6" instead of "internal1.6"
**Blocking:** Could not delete due to "used by other entries" (firewall policy)
**Solution:**
  - Attempted to delete firewall policy - blocked by FIPS-CC policies
  - Changed approach: temporarily modified policy source interface
  - Deleted interface
  - Recreated with correct name
  - Fixed policy back
**Lesson:** Check for dependencies before deleting objects

### 4. SSH Cipher Configuration Commands Not Available
**Issue:** `set ssh-enc-algo` and related commands not found
**Root Cause:** FIPS-CC mode automatically restricts SSH to FIPS-approved ciphers
**Solution:** Skipped SSH cipher configuration - already handled by FIPS-CC
**Result:** No action needed, FIPS-CC provides the security

### 5. DHCP Not Working on Management Port
**Issue:** Computer not getting IP from dmz port initially
**Root Cause:**
  - DNS not configured in DHCP server
  - Port not enabled
**Solution:**
  - Set dns-service specify
  - Added dns-server1 and dns-server2
  - Set interface status up
**Result:** DHCP working, computer got IP and DNS

### 6. Firewall Policy Not Working
**Issue:** Ping working from FortiGate but not from PC
**Root Cause:** Firewall policy not enabled (status: disabled by default)
**Solution:** `set status enable` on policy
**Result:** Internet access working immediately
**Lesson:** Always enable firewall policies after creation

### 7. FortiGuard Connectivity Failures During Testing
**Issue:** "Unauthorized" errors when checking for updates
**Root Cause:** Device not registered, no active licenses initially
**Solution:** Registered device at support.fortinet.com with serial number
**Result:** Access to firmware downloads, FortiGuard services available
**Note:** Active licenses through November 2028

### 8. Trunk Interface Configuration
**Issue:** Could not set mode on physical interface for trunk
**Root Cause:** FortiGate interface architecture - trunk mode not set directly
**Solution:** Just configure VLAN sub-interfaces; parent automatically trunks
**Result:** VLAN interfaces created successfully
**Lesson:** Don't overthink FortiGate interface configuration

---

## Important Context for Next Session

### 1. Current State
- FortiGate fully configured, console access only
- No network cables connected
- Configuration saved (GUI backup downloaded)
- FIPS-CC mode enabled and active
- All settings applied and verified via CLI
- Ready for physical deployment

### 2. Physical Deployment Pending
**Cables to connect:**
- Fiber/ISP → wan1 (VLAN 847 must be tagged)
- UniFi switch → any internal port (trunk with VLANs 3,4,5,6)

**Expected behavior when connected:**
- wan1.847 should come up with 204.186.251.250
- Internal interfaces should come up when switch connected
- DHCP should start assigning IPs
- Internet should be immediately accessible

### 3. Next Session Goals
**Primary:** SSL VPN Configuration with Azure AD SAML

**Tasks:**
1. Register FortiGate as Enterprise Application in Azure AD
2. Configure SAML SSO connector on FortiGate
3. Create VPN user group in Azure AD
4. Configure SSL VPN portal
5. Set up admin authentication via Azure AD
6. Test VPN with FortiClient
7. Verify full tunnel working
8. Confirm no internal network access from VPN
9. Test MFA enforcement

**Prerequisites for next session:**
- Internet connectivity working
- Access to Azure AD admin portal
- Ability to create enterprise applications
- Test user accounts in Azure AD
- FortiClient downloaded and ready to test

### 4. Credentials & Access
**Current Access:**
- GUI: Will be https://172.16.4.1 (from CORP network)
- Console: USB-C, 9600 baud, 8N1
- Username: admin
- Password: 15+ character password set during FIPS-CC enablement
- SSH: Will be available after deployment on CORP network

**Important:** User has the admin password - not documented here for security

### 5. Network Topology
**From SonicWall:**
- X0:V3 → internal1.3 (IoT)
- X0:V4 → internal1.4 (CORP) ✓
- X0:V5 → internal1.5 (Studio) ✓
- X0:V6 → internal1.6 (Guest) ✓
- X1:V847 → wan1.847 (Fiber WAN) ✓
- X1:V1449 → Not migrated yet (if needed later)

**UniFi Infrastructure:**
- VLANs already configured and operational
- Ready to connect to FortiGate trunk port
- Users currently on SonicWall

### 6. Outstanding CMMC Requirements
**Still needed for full CMMC Level 2 compliance:**
- Centralized logging (syslog or FortiAnalyzer)
- Individual admin accounts (no shared admin)
- MFA enforcement (will be via Azure AD)
- System Security Plan documentation
- Regular configuration backups automation
- Incident response procedures documentation

### 7. Testing Checklist for After Deployment
- [ ] wan1.847 status up with correct IP
- [ ] Default route via 204.186.251.249
- [ ] Ping 8.8.8.8 from FortiGate
- [ ] Ping google.com from FortiGate
- [ ] All 4 VLANs get DHCP addresses
- [ ] Internet access from all VLANs
- [ ] VLAN isolation verified (cannot ping between VLANs)
- [ ] GUI accessible from CORP network
- [ ] SSH accessible from CORP network
- [ ] Firewall logs showing traffic

---

## Key Technical Details

### Serial Number
**FGT60FTK24031122**
- Registered at support.fortinet.com
- Active licenses through November 2028

### Firmware
**FortiOS 7.4.9 build2829 (GA.M)**
- Release: September 2023
- Type: Mature/Stable GA release
- FIPS-CC: Supported ✓

### FIPS-CC Mode
**Status:** Enabled
**Security Level:** High
**Implications:**
- All cryptographic operations use FIPS 140-2 validated modules
- Cannot be disabled without factory reset
- Automatically enforces secure ciphers
- More restrictive than standard mode

### Interface Architecture
**Physical Interfaces:**
- wan1, wan2: WAN ports
- internal1-5: LAN ports (members of "internal" switch)
- dmz: Standalone DMZ port
- a, b: FortiLink ports (for FortiSwitch)

**Logical Interfaces:**
- internal: Hard-switch containing internal1-5
- wan1.847: VLAN sub-interface for WAN
- internal1.3, internal1.4, internal1.5, internal1.6: VLAN sub-interfaces
- ssl.root: SSL VPN interface (auto-created)
- Various tunnel interfaces (naf.root, l2t.root)

### Policy Numbering
**1-6:** FIPS-CC default security policies (do not modify)
**11-15:** User-created internet access policies
**Future:** 16+ available for additional policies

---

## Commands Reference

### Key Show Commands
```bash
get system status                  # Device info, version, FIPS status
show system interface             # All interface config
get system interface physical     # Physical interface status
show firewall policy              # All firewall policies
show system dhcp server           # DHCP server config
get router info routing-table all # Routing table
show full-configuration           # Complete config export
```

### Verification Commands
```bash
get system interface wan1.847     # Check WAN status
execute ping 8.8.8.8              # Test internet from FortiGate
execute dhcp lease-list           # Show DHCP leases
diagnose sys fips status          # Verify FIPS-CC status
diagnose debug flow               # Debug firewall traffic
```

### Backup Commands
```bash
# Via GUI: System > Configuration > Backup
# Download configuration file
```

---

## Files Created This Session

**Location:** `C:\Giterepos\fortigate-cmmc-setup\`

1. **CONTEXT.md**
   - Complete configuration details
   - All IP addresses, VLANs, policies
   - CMMC compliance settings
   - Access information

2. **TODO.md**
   - Comprehensive post-deployment task list
   - Organized by priority (High/Medium/Low)
   - Commands and procedures included
   - CMMC assessment prep checklist

3. **DEPLOYMENT-READY.md**
   - Step-by-step deployment guide
   - Verification commands
   - Success criteria
   - Rollback plan
   - Emergency information

4. **SESSION-NOTES.md** (this file)
   - Session summary and context
   - Decisions made and why
   - Issues encountered and solutions
   - Next session preparation
   - Context for continuity

5. **[GUI backup file].conf**
   - Binary configuration backup
   - Downloaded via GUI before disconnect
   - Can be used for restore if needed

---

## User Environment & Preferences

### Organization Profile
- **Type:** Cloud-first organization
- **Infrastructure:** Microsoft 365 tenant, Azure AD
- **Switching:** UniFi (Ubiquiti)
- **Previous Firewall:** SonicWall (being replaced)
- **Compliance:** CMMC Level 2 required
- **Use Case:** DoD contractor handling CUI

### Technical Approach
- Prefers CLI for initial config, GUI for ongoing management
- Values documentation and clear explanations
- Wants to understand "why" not just "how"
- Methodical, cautious approach
- Security-focused

### VPN Requirements
- **Purpose:** Secure internet for traveling staff
- **Type:** Full tunnel SSL VPN
- **Access:** Internet only (no internal network access)
- **Authentication:** Azure AD with MFA
- **Client:** FortiClient
- **Use Case:** Protect staff when on public WiFi, traveling

### Future Plans
- VPN with Azure AD SAML (next session)
- Admin authentication via Azure AD
- Centralized logging
- Individual admin accounts
- Automated backups
- Possible IPsec site-to-site VPNs (future)

---

## Tips for Next Session

### 1. Start by Reviewing Status
```bash
get system status                 # Verify FIPS-CC still enabled
get system interface wan1.847     # Check if internet connected
get router info routing-table all # Verify routing
execute ping 8.8.8.8             # Test connectivity
```

### 2. If Internet is Working
- Proceed immediately to VPN configuration
- Have Azure AD portal ready
- Have FortiClient downloaded

### 3. If Internet is Not Working
- Review DEPLOYMENT-READY.md troubleshooting section
- Check physical connections
- Verify wan1.847 status
- Check routing table
- Review firewall logs

### 4. Azure AD Preparation
Before starting VPN config, gather:
- Azure AD tenant ID
- Admin credentials for Azure portal
- List of users who need VPN access
- Desired VPN user group name
- MFA enforcement policy decisions

### 5. Testing Accounts
Have ready:
- Test user account in Azure AD
- FortiClient installed on test device
- Device not on internal network (for external VPN testing)

---

## Important Reminders

### DO NOT
- ❌ Disable FIPS-CC mode (requires factory reset)
- ❌ Delete FIPS-CC default policies (1-6)
- ❌ Modify FIPS-CC policies without understanding impact
- ❌ Change admin password to less than 15 characters
- ❌ Expose management interface to WAN
- ❌ Allow inter-VLAN traffic without explicit policy and CMMC review

### DO
- ✅ Create configuration backups before major changes
- ✅ Test in phases (internet first, then VPN)
- ✅ Document all changes
- ✅ Use individual accounts for admins (not shared admin)
- ✅ Enable and test MFA
- ✅ Monitor logs regularly
- ✅ Keep firmware updated

### Security Notes
- FIPS-CC mode is irreversible
- All passwords must meet 15+ character policy
- All admin access should be via Azure AD (post-VPN config)
- All traffic is logged for CMMC compliance
- VLANs are isolated (no inter-VLAN routing)
- Management only accessible from CORP network

---

## Success Metrics

### Configuration Phase (Complete ✅)
- ✅ FIPS-CC mode enabled
- ✅ CMMC Level 2 settings applied
- ✅ All VLANs configured
- ✅ DHCP configured
- ✅ Firewall policies created
- ✅ Production WAN configured
- ✅ Documentation complete

### Deployment Phase (Pending)
- [ ] Physical connections made
- [ ] wan1.847 operational
- [ ] Internet working from all VLANs
- [ ] VLAN isolation verified
- [ ] Management accessible

### VPN Phase (Next Session)
- [ ] SSL VPN portal configured
- [ ] Azure AD SAML working
- [ ] Admin auth via Azure AD
- [ ] MFA enforced
- [ ] Full tunnel verified
- [ ] No internal access confirmed

### CMMC Phase (Ongoing)
- [ ] Centralized logging operational
- [ ] Individual admin accounts
- [ ] Regular backups automated
- [ ] System Security Plan documented
- [ ] Ready for C3PAO assessment

---

## Contact for Next Session

**When ready for next session, provide:**
1. Deployment status (success/issues)
2. Internet connectivity confirmed (yes/no)
3. Any errors or unexpected behavior
4. Ready for VPN configuration (yes/no)
5. Azure AD access available (yes/no)

**Files to reference:**
- This file (SESSION-NOTES.md) - for context
- CONTEXT.md - for configuration details
- DEPLOYMENT-READY.md - for deployment steps
- TODO.md - for task list

**Expected next session duration:** 2-3 hours for complete VPN setup with Azure AD SAML

---

**Session Status:** COMPLETE ✅
**Next Step:** Physical deployment
**Configuration Confidence:** HIGH
**Ready for Production:** YES

---

*These notes provide complete context for continuing this configuration in a future session. All technical details, decisions, and next steps are documented for seamless continuity.*
